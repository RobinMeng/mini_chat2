# 使用说明

## 应用程序界面

### 主窗口布局

```
┌───┬────────────┬────────────────────────────┐
│ M │            │                            │
│   │  Messages  │       Contact Name      (○)│
├───┤            ├────────────────────────────┤
│ 🗨 │  [Search]  │                            │
│   │            │      [ Chat History ]      │
├───┤  ● Alice 1 │                            │
│ 👥 │  ● Bob     │                            │
│   │  ○ Carol   │                            │
├───┤            ├────────────────────────────┤
│ 📁 │            │ [ Write a message...  ] [✈]│
├───┤            │                            │
│ ⚙ │            │                            │
└───┴────────────┴────────────────────────────┘
(侧边栏) (联系人列表)        (主聊天区域)
```

## 基本操作

### 1. 启动应用

```bash
python run.py
```

启动后会自动：
- 初始化临时数据库（`data/chat.db`）
- 创建日志文件（`logs/minichat.log`）
- 生成唯一用户 ID (每次启动均不同)
- 启动 UDP 广播服务（端口 9999）
- 启动 TCP 消息服务（端口 10000）
- 显示主窗口

### 2. 自动发现用户

应用启动后会：
- 每 5 秒发送一次心跳包（UDP 广播）
- 自动发现局域网内的其他用户
- 在左侧用户列表中显示在线用户
- 用户前显示绿色圆点 🟢 表示在线

### 3. 开始聊天

**选择聊天对象：**
1. 双击左侧用户列表中的用户
2. 聊天区域标题会显示：`与 XXX 聊天`
3. 发送按钮变为可用状态

**发送消息：**
- 方式 1：在输入框输入消息，点击右侧的纸飞机图标按钮
- 方式 2：在输入框输入消息，按 Enter 键发送
- 方式 3：按 Ctrl+Enter 也可以触发发送

**查看消息：**
- 自己发送的消息显示在右侧（蓝色背景）
- 接收的消息显示在左侧（灰色背景）
- 每条消息显示发送者昵称

### 4. 查看聊天历史

- 选择用户后自动加载最近 50 条聊天记录
- 聊天记录临时保存在本地数据库中
- **注意**: 这是一个“阅后即焚”应用。一旦关闭程序，所有本地记录和用户信息都会被物理删除，下次打开时无法找回历史消息。

## 高级功能

### 修改用户昵称

默认使用主机名作为昵称，可以在代码中修改：

```python
# src/ui/main_window.py
# 修改 _init_current_user 方法
current_user = self.user_manager.initialize_current_user("我的昵称")
```

### 修改网络端口

如果默认端口被占用，可以修改：

```python
# src/config.py
BROADCAST_PORT = 9999  # UDP 广播端口
TCP_PORT = 10000       # TCP 消息端口
```

### 查看日志

应用运行时会生成详细日志：

```bash
# 实时查看日志
tail -f logs/minichat.log

# 查看最近的日志
cat logs/minichat.log
```

日志包含：
- 用户发现事件
- 消息发送/接收记录
- 网络连接状态
- 错误信息

## 多用户测试

### 在同一台电脑测试

应用已支持 `SO_REUSEPORT`，可以直接开启多个实例：
1. 正常运行第一个 `python run.py`。
2. 通过设置环境变量运行第二个实例：`TCP_PORT=10001 DATA_DIR=./data2 python run.py`。
3. 两个窗口会互相发现，即可进行 P2P 聊天测试。

### 在局域网内测试

1. 在电脑 A 上运行：
```bash
python run.py
```

2. 在电脑 B 上运行：
```bash
python run.py
```

3. 稍等几秒，两台电脑会互相发现对方
4. 双击用户列表中的对方昵称开始聊天

## 网络要求

### 必需条件
- 所有设备在同一局域网内
- 防火墙允许以下端口：
  - UDP 9999（广播）
  - TCP 10000（消息）

### 防火墙配置

**macOS:**
```bash
# 查看防火墙状态
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --getglobalstate

# 临时关闭防火墙（测试用）
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off
```

**Windows:**
- 打开 Windows Defender 防火墙
- 点击"允许应用通过防火墙"
- 添加 Python 应用程序
- 允许专用和公用网络

**Linux:**
```bash
# 允许端口
sudo ufw allow 9999/udp
sudo ufw allow 10000/tcp
```

## 故障排除

### 问题：无法发现其他用户

**可能原因：**
1. 不在同一局域网内
2. 防火墙阻止了 UDP 9999 端口
3. 网络不支持广播

**解决方法：**
1. 确认设备在同一网段（如 192.168.1.x）
2. 临时关闭防火墙测试
3. 查看日志确认广播服务是否正常

### 问题：消息发送失败

**可能原因：**
1. 防火墙阻止了 TCP 10000 端口
2. 对方用户已离线
3. 网络连接不稳定

**解决方法：**
1. 检查防火墙设置
2. 确认对方用户在线（用户列表中显示）
3. 查看日志中的错误信息

### 问题：端口被占用

**错误提示：**
```
OSError: [Errno 48] Address already in use
```

**解决方法：**
1. 修改 `src/config.py` 中的端口配置
2. 或关闭占用端口的其他程序

### 问题：应用启动失败

**可能原因：**
1. 缺少依赖包
2. Python 版本过低

**解决方法：**
```bash
# 检查 Python 版本（需要 3.8+）
python --version

# 重新安装依赖
pip install -r requirements.txt
```

## 性能说明

### 资源占用
- CPU：< 5%（空闲时）
- 内存：约 50-100 MB
- 网络：每 5 秒约 1 KB（心跳包）

### 支持规模
- 推荐用户数：< 50 人
- 最大并发消息：取决于网络带宽
- 消息延迟：< 100ms（局域网）

### 数据库大小
- 消息记录：约 1 KB/条
- 1000 条消息约占用 1 MB

## 安全说明

### 当前版本
- ⚠️ 消息未加密，明文传输
- ⚠️ 无身份验证机制
- ⚠️ 仅适用于可信任的局域网环境

### 安全建议
- 仅在私有局域网内使用
- 不要传输敏感信息
- 定期清理聊天记录

### 后续计划
- [ ] 实现 AES 消息加密
- [ ] 添加数字签名验证
- [ ] 支持白名单机制

## 快捷键

- `Enter` - 发送消息
- `Shift+Enter` - 换行
- `Ctrl+W` / `Cmd+W` - 关闭窗口（计划中）
- `Ctrl+Q` / `Cmd+Q` - 退出应用（计划中）

## 更多帮助

- 查看设计文档：`docs/设计文档.md`
- 查看开发计划：`docs/开发计划.md`
- 查看技术规格：`docs/技术规格说明.md`
- 查看开发指南：`docs/开发指南.md`
