# 局域网聊天工具设计文档

## 1. 项目概述

### 1.1 项目名称
MiniChat - 局域网即时通讯工具

### 1.2 项目目标
开发一个基于 Python 和 PyQt 的局域网聊天工具，用户无需登录，可在同一局域网内自动发现其他用户并进行实时通讯。

### 1.3 核心特性
- 无需登录，自动识别用户
- 局域网内自动发现在线用户
- 实时消息传输
- 支持一对一聊天
- 支持群组聊天
- 文件传输功能
- **未读提醒**: 支持显示每个联系人的未读消息数量，确保重要信息不被遗漏
- **隐私保护**: 阅后即焚模式，退出程序后自动清理所有本地用户信息与聊天记录，实现“无痕运行”
- 简洁友好的图形界面

## 2. 技术栈

### 2.1 开发语言
- Python 3.8+

### 2.2 核心库
- **PyQt5 (QtQuick/QML)**: GUI 框架，用于现代化的 UI 开发
- **socket + selectors**: 高性能 I/O 多路复用网络通信
- **threading**: 多线程处理（UDP 广播、网络监听等）
- **json**: 数据序列化
- **hashlib**: 用户标识生成

### 2.3 可选库
- **zeroconf**: 服务发现（mDNS）
- **cryptography**: 消息加密（可选）

## 3. 系统架构

### 3.1 架构模式
采用 **MVC (Model-View-Controller)** 与 **P2P + 广播** 混合架构：

```
┌─────────────────────────────────────────────────────────────┐
│                  视图层 (View - QML)                         │
│  - MainWindow.qml (主界面布局)                               │
│  - UserListDelegate.qml (用户列表项样式)                     │
│  - MessageDelegate.qml (消息气泡样式)                       │
└──────────────────────────────┬──────────────────────────────┘
                               │ (Signals / Slots)
┌──────────────────────────────┴──────────────────────────────┐
│                控制层 (Controller - Python)                  │
│  - QmlBackend (桥接类): 处理 UI 事件，调度核心逻辑           │
│  - 属性映射: 将 Python 对象状态同步到 QML 属性               │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────┴──────────────────────────────┐
│                模型层 (Model - Python)                       │
│  - UserManager: 用户状态与在线列表                           │
│  - MessageManager: 消息处理与历史记录                        │
│  - DatabaseManager: SQLite 数据持久化                        │
└──────────────────────────────┬──────────────────────────────┘
                               │
┌──────────────────────────────┴──────────────────────────────┐
│                网络层 (Network Layer)                        │
│  - UDP 广播 (用户发现)                                       │
│  - TCP selectors (加密消息传输)                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 模块划分

#### 3.2.1 网络通信模块
- **BroadcastService**: UDP 广播服务，用于用户发现
- **MessageService**: TCP 消息服务，用于消息传输
- **FileTransferService**: 文件传输服务

#### 3.2.2 用户管理模块
- **UserManager**: 管理在线用户列表
- **UserProfile**: 用户信息类

#### 3.2.3 消息管理模块
- **MessageManager**: 消息队列管理
- **Message**: 消息数据类

#### 3.2.4 界面模块
- **MainWindow**: 主窗口
- **ChatWindow**: 聊天窗口
- **UserListWidget**: 用户列表组件
- **MessageWidget**: 消息显示组件

## 4. 详细设计

### 4.1 用户发现机制

#### 4.1.1 广播协议
- 使用 UDP 广播在局域网内发现用户
- 默认端口: 9999
- 广播间隔: 每 5 秒一次心跳

#### 4.1.2 消息格式
```json
{
    "type": "HEARTBEAT",
    "user_id": "unique_user_id",
    "username": "用户昵称",
    "hostname": "主机名",
    "ip": "192.168.1.100",
    "port": 10000,
    "timestamp": 1234567890
}
```

#### 4.1.3 用户识别
- 使用 MAC 地址 + 主机名生成唯一 user_id
- 用户可自定义昵称（默认使用主机名）

### 4.2 消息传输机制

#### 4.2.1 TCP 连接
- 每个客户端监听一个 TCP 端口（默认 10000）
- 采用 **I/O 多路复用 (selectors)** 模型，单线程高效处理多个并发连接
- 核心收发逻辑封装在 `network_utils.py` 中，支持自动拆包和粘包处理

#### 4.2.2 消息协议
采用 **4字节长度前缀 + JSON 消息体** 的流式协议：
1. **长度前缀**: 4 字节（大端序），记录 JSON 数据长度
2. **消息体**: UTF-8 编码的 JSON 字符串

#### 4.2.3 消息结构
```json
{
    "msg_id": "unique_message_id",
    "type": "TEXT",
    "from_user": "user_id",
    "to_user": "user_id",
    "content": "消息内容",
    "timestamp": 1234567890,
    "is_group": false
}
```

### 4.3 文件传输设计

#### 4.3.1 传输流程
1. 发送方发送文件元数据
2. 接收方确认是否接收
3. 分块传输文件数据
4. 接收方确认每块数据
5. 传输完成后校验文件完整性

#### 4.3.2 文件元数据
```json
{
    "file_id": "unique_file_id",
    "filename": "document.pdf",
    "filesize": 1024000,
    "checksum": "md5_hash",
    "chunk_size": 4096
}
```

### 4.4 数据存储 (阅后即焚模式)

#### 4.4.1 存储策略
本项目采用**临时持久化/全内存**机制，核心原则是“生命周期对齐”：
- **运行期间**: 为了保证 QML 界面在大数据量下的查询性能和 MVC 架构的兼容性，系统会在本地 `data/` 目录下创建临时的 SQLite 数据库文件。
- **退出清理**: 当用户通过 UI 正常关闭程序或触发 `onClosing` 事件时，控制层（Controller）将强制触发 `DatabaseManager` 的清理逻辑，物理删除 `data/` 目录下的所有数据库文件和临时缓存。
- **冷启动**: 每次程序启动时，都会自动检测并重建一套全新的、空白的数据库表结构，确保不加载任何历史数据。

#### 4.4.2 数据库表结构
```sql
-- 用户表
CREATE TABLE users (
    user_id TEXT PRIMARY KEY,
    username TEXT,
    last_seen INTEGER
);

-- 消息表
CREATE TABLE messages (
    msg_id TEXT PRIMARY KEY,
    from_user TEXT,
    to_user TEXT,
    content TEXT,
    timestamp INTEGER,
    is_read BOOLEAN
);

-- 文件传输记录表
CREATE TABLE file_transfers (
    file_id TEXT PRIMARY KEY,
    filename TEXT,
    filesize INTEGER,
    status TEXT,
    timestamp INTEGER
);
```

## 5. 界面设计

### 5.1 主窗口布局
```
┌────────────────────────────────────────┐
│  MiniChat                       [_][□][X]│
├────────────┬───────────────────────────┤
│            │                           │
│  用户列表   │      聊天区域              │
│            │                           │
│  ● Alice   │  [聊天消息显示区]          │
│  ● Bob     │                           │
│  ● Carol   │                           │
│            │                           │
│            │  ┌─────────────────────┐  │
│            │  │ 输入框              │  │
│            │  └─────────────────────┘  │
│            │  [文件] [表情] [发送]     │
└────────────┴───────────────────────────┘
```

### 5.2 主要界面组件

#### 5.2.1 用户列表
- 显示所有在线用户
- 用户状态指示（在线/离线）
- **未读消息提醒**: 在用户头像或昵称右侧显示红色数字气泡，提示未读消息数量
- 双击打开聊天窗口，**自动清除**该用户的未读状态

#### 5.2.2 聊天窗口
- 消息历史显示
- 消息输入框
- 发送按钮、文件按钮
- 支持表情选择（可选）

#### 5.2.3 系统托盘
- 最小化到系统托盘
- 新消息提醒
- 快速打开主窗口

## 6. 项目目录结构

```
mini_chat2/
├── docs/                    # 文档目录
├── src/                     # 源代码目录
│   ├── main.py             # 程序入口 (初始化 QML 引擎)
│   ├── network/            # 网络模块
│   ├── core/               # 核心业务逻辑 (Model)
│   ├── ui/                 # 界面模块 (View + Controller)
│   │   ├── qml/            # QML 视图文件 (.qml)
│   │   │   ├── MainWindow.qml
│   │   │   ├── UserList.qml
│   │   │   └── ChatArea.qml
│   │   ├── backend.py      # QML 后端桥接逻辑 (Controller)
│   │   └── __init__.py
│   ├── database/           # 数据库模块
│   └── utils/              # 工具类
├── resources/               # 静态资源 (图片、图标等)
├── tests/                   # 测试代码
├── data/                    # 数据目录 (SQLite DB)
└── run.py                   # 快捷启动脚本
├── resources/              # 资源文件
│   ├── icons/             # 图标
│   │   ├── app.png        # 应用图标
│   │   ├── user.png       # 用户图标
│   │   ├── send.png       # 发送按钮图标
│   │   └── file.png       # 文件图标
│   ├── images/            # 图片
│   ├── styles/            # 样式表
│   │   ├── light.qss      # 浅色主题
│   │   └── dark.qss       # 深色主题
│   └── resources.qrc      # Qt 资源文件
├── tests/                 # 测试代码
│   ├── __init__.py
│   ├── test_network.py
│   ├── test_user_manager.py
│   └── test_message.py
├── data/                  # 数据目录
│   └── chat.db           # SQLite数据库
├── logs/                  # 日志目录
│   └── minichat.log      # 应用日志
├── scripts/               # 工具脚本
│   ├── compile_ui.py     # 编译所有 .ui 文件为 .py
│   └── compile_qrc.py    # 编译 .qrc 资源文件
├── requirements.txt       # 依赖列表
├── README.md             # 项目说明
└── setup.py              # 安装脚本
```

### 6.1 QML 与 Python 交互规范

#### 6.1.1 职责分离
- **QML (View)**: 只负责展示。通过 `rootContext.setContextProperty` 访问后端对象。
- **Python (Controller)**: 定义 `QmlBackend` 类，包含 `@pyqtProperty`（属性）、`@pyqtSlot`（槽函数）和 `pyqtSignal`（信号）。

#### 6.1.2 交互流
1. **初始化**: `main.py` 创建 `QQmlApplicationEngine`，将 `QmlBackend` 实例注入上下文。
2. **数据流 (Back -> Front)**: Python 模型更新 -> 触发 Python 信号 -> QML 自动捕获并更新界面（包括联系人列表的未读数更新）。
3. **操作流 (Front -> Back)**: 用户点击按钮 -> 调用 QML 中的槽函数 -> 执行 Python 业务逻辑（如发送消息、切换聊天对象并标记消息已读）。
4. **清理流 (Lifecycle)**: 用户关闭窗口 -> QML 触发 `backend.stop()` -> 停止网络服务并**物理删除本地数据库文件** -> 进程退出。

#### 6.1.3 模型管理
- 用户列表使用 `QAbstractListModel` 的 Python 实现，提供给 QML 的 `ListView` 使用，确保高性能大数据量渲染。

#### 6.1.4 样式与视图分离 (Styling Separation)
- **样式常量收口**: 所有的颜色值、字体大小、边距、圆角等 UI 常量必须统一定义在专门的样式配置文件中（例如 `Theme.qml` 或作为全局单例）。
- **严禁硬编码**: 禁止在业务逻辑布局（如 `MainWindow.qml`）中直接使用十六进制颜色（代码如 `#FFFFFF`）或具体的像素值。
- **主题支持**: 视图层组件应引用样式变量（如 `color: Theme.background`）。这种架构设计旨在通过后期替换或修改样式配置文件，即可实现全应用的主题切换（如深色模式、浅色模式）。

### 6.2 资源文件管理

## 7. 开发计划

### 7.1 第一阶段：基础框架（1-2周）
- [x] 项目结构搭建
- [ ] 基础配置管理
- [ ] 日志系统
- [ ] 数据库设计与实现

### 7.2 第二阶段：网络通信（2-3周）
- [ ] UDP 广播服务实现
- [ ] TCP 消息服务实现
- [ ] 用户发现机制
- [ ] 消息收发测试

### 7.3 第三阶段：核心功能（2-3周）
- [ ] 用户管理功能
- [ ] 消息管理功能
- [ ] 聊天历史存储
- [ ] 消息队列处理

### 7.4 第四阶段：界面开发（2-3周）
- [ ] 主窗口设计与实现
- [ ] 聊天窗口实现
- [ ] 用户列表组件
- [ ] 消息显示组件

### 7.5 第五阶段：高级功能（2周）
- [ ] 文件传输功能
- [ ] 群组聊天
- [ ] 表情支持
- [ ] 系统托盘

### 7.6 第六阶段：测试与优化（1-2周）
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] Bug 修复

## 8. 技术要点

### 8.1 多线程设计
- UI 线程：处理界面更新与用户交互
- 网络监听线程 (UDP)：持续监听局域网内的用户发现广播
- 网络服务线程 (TCP)：基于 **selectors** 的事件循环，负责所有点对点消息的非阻塞收发

### 8.2 线程安全
- 使用 QMutex 保护共享数据
- 使用信号槽机制跨线程通信
- 消息队列使用线程安全的数据结构

### 8.3 异常处理
- 网络异常处理
- 文件读写异常
- 数据库异常
- 完善的日志记录

### 8.4 性能优化
- 消息缓存机制
- 数据库连接池
- 大文件分块传输
- 图片压缩与缓存

## 9. 安全考虑

### 9.1 基础安全
- 输入验证
- 文件类型检查
- 文件大小限制
- 防止恶意广播

### 9.2 可选增强
- 消息加密（AES）
- 数字签名验证
- 白名单机制
- 访问控制

## 10. 后续扩展方向

### 10.1 功能扩展
- 语音通话
- 视频通话
- 屏幕共享
- 远程协助

### 10.2 跨平台
- Windows 可执行文件打包
- macOS 应用打包
- Linux 支持

### 10.3 云同步（可选）
- 消息云同步
- 配置云同步
- 多设备支持

## 11. 依赖库列表

```txt
PyQt5>=5.15.0
PyQt5-Qt5>=5.15.0
PyQt5-sip>=12.8.0
```

可选依赖：
```txt
zeroconf>=0.38.0      # 服务发现
cryptography>=3.4.0   # 加密功能
pillow>=8.0.0         # 图片处理
```

## 12. 配置文件示例

```python
# config.py
class Config:
    # 网络配置
    BROADCAST_PORT = 9999
    MESSAGE_PORT = 10000
    BROADCAST_INTERVAL = 5  # 秒
    
    # 用户配置
    DEFAULT_USERNAME = ""  # 留空使用主机名
    
    # 文件传输配置
    CHUNK_SIZE = 4096
    MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB
    
    # 数据库配置
    DB_PATH = "data/chat.db"
    
    # UI配置
    WINDOW_WIDTH = 900
    WINDOW_HEIGHT = 600
    
    # 日志配置
    LOG_LEVEL = "INFO"
    LOG_FILE = "logs/minichat.log"
```

---

**文档版本**: v1.2  
**创建日期**: 2026-01-21  
**最后更新**: 2026-01-24 (新增“阅后即焚”模式与“未读消息提醒”功能设计)
