# 局域网聊天工具设计文档

## 1. 项目概述

### 1.1 项目名称
MiniChat - 局域网即时通讯工具

### 1.2 项目目标
开发一个基于 Python 和 PyQt 的局域网聊天工具，用户无需登录，可在同一局域网内自动发现其他用户并进行实时通讯。

### 1.3 核心特性
- 无需登录，自动识别用户
- 局域网内自动发现在线用户
- 实时消息传输
- 支持一对一聊天
- 支持群组聊天
- 文件传输功能
- 简洁友好的图形界面

## 2. 技术栈

### 2.1 开发语言
- Python 3.8+

### 2.2 核心库
- **PyQt5/PyQt6**: GUI 框架
- **socket**: 网络通信
- **threading**: 多线程处理
- **json**: 数据序列化
- **pickle**: 对象序列化
- **hashlib**: 用户标识生成

### 2.3 可选库
- **zeroconf**: 服务发现（mDNS）
- **cryptography**: 消息加密（可选）

## 3. 系统架构

### 3.1 架构模式
采用 **P2P（点对点）+ 广播** 混合架构

```
┌─────────────────────────────────────────┐
│           应用层（UI Layer）              │
│  - 主窗口                                 │
│  - 聊天窗口                               │
│  - 用户列表                               │
└─────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────┐
│         业务逻辑层（Business Layer）      │
│  - 消息管理器                             │
│  - 用户管理器                             │
│  - 文件传输管理器                         │
└─────────────────────────────────────────┘
                    ↓↑
┌─────────────────────────────────────────┐
│         网络层（Network Layer）           │
│  - UDP 广播（用户发现）                   │
│  - TCP 连接（消息传输）                   │
│  - 文件传输协议                           │
└─────────────────────────────────────────┘
```

### 3.2 模块划分

#### 3.2.1 网络通信模块
- **BroadcastService**: UDP 广播服务，用于用户发现
- **MessageService**: TCP 消息服务，用于消息传输
- **FileTransferService**: 文件传输服务

#### 3.2.2 用户管理模块
- **UserManager**: 管理在线用户列表
- **UserProfile**: 用户信息类

#### 3.2.3 消息管理模块
- **MessageManager**: 消息队列管理
- **Message**: 消息数据类

#### 3.2.4 界面模块
- **MainWindow**: 主窗口
- **ChatWindow**: 聊天窗口
- **UserListWidget**: 用户列表组件
- **MessageWidget**: 消息显示组件

## 4. 详细设计

### 4.1 用户发现机制

#### 4.1.1 广播协议
- 使用 UDP 广播在局域网内发现用户
- 默认端口: 9999
- 广播间隔: 每 5 秒一次心跳

#### 4.1.2 消息格式
```json
{
    "type": "HEARTBEAT",
    "user_id": "unique_user_id",
    "username": "用户昵称",
    "hostname": "主机名",
    "ip": "192.168.1.100",
    "port": 10000,
    "timestamp": 1234567890
}
```

#### 4.1.3 用户识别
- 使用 MAC 地址 + 主机名生成唯一 user_id
- 用户可自定义昵称（默认使用主机名）

### 4.2 消息传输机制

#### 4.2.1 TCP 连接
- 每个客户端监听一个 TCP 端口（默认 10000）
- 点对点直接建立 TCP 连接传输消息

#### 4.2.2 消息类型
```python
MESSAGE_TYPES = {
    'TEXT': 1,        # 文本消息
    'FILE': 2,        # 文件传输
    'IMAGE': 3,       # 图片消息
    'HEARTBEAT': 4,   # 心跳包
    'ACK': 5,         # 确认消息
    'USER_JOIN': 6,   # 用户加入
    'USER_LEAVE': 7   # 用户离开
}
```

#### 4.2.3 消息结构
```json
{
    "msg_id": "unique_message_id",
    "type": "TEXT",
    "from_user": "user_id",
    "to_user": "user_id",
    "content": "消息内容",
    "timestamp": 1234567890,
    "is_group": false
}
```

### 4.3 文件传输设计

#### 4.3.1 传输流程
1. 发送方发送文件元数据
2. 接收方确认是否接收
3. 分块传输文件数据
4. 接收方确认每块数据
5. 传输完成后校验文件完整性

#### 4.3.2 文件元数据
```json
{
    "file_id": "unique_file_id",
    "filename": "document.pdf",
    "filesize": 1024000,
    "checksum": "md5_hash",
    "chunk_size": 4096
}
```

### 4.4 数据存储

#### 4.4.1 本地存储
- 使用 SQLite 存储聊天历史
- 存储用户配置信息
- 缓存文件信息

#### 4.4.2 数据库表结构
```sql
-- 用户表
CREATE TABLE users (
    user_id TEXT PRIMARY KEY,
    username TEXT,
    last_seen INTEGER
);

-- 消息表
CREATE TABLE messages (
    msg_id TEXT PRIMARY KEY,
    from_user TEXT,
    to_user TEXT,
    content TEXT,
    timestamp INTEGER,
    is_read BOOLEAN
);

-- 文件传输记录表
CREATE TABLE file_transfers (
    file_id TEXT PRIMARY KEY,
    filename TEXT,
    filesize INTEGER,
    status TEXT,
    timestamp INTEGER
);
```

## 5. 界面设计

### 5.1 主窗口布局
```
┌────────────────────────────────────────┐
│  MiniChat                       [_][□][X]│
├────────────┬───────────────────────────┤
│            │                           │
│  用户列表   │      聊天区域              │
│            │                           │
│  ● Alice   │  [聊天消息显示区]          │
│  ● Bob     │                           │
│  ● Carol   │                           │
│            │                           │
│            │  ┌─────────────────────┐  │
│            │  │ 输入框              │  │
│            │  └─────────────────────┘  │
│            │  [文件] [表情] [发送]     │
└────────────┴───────────────────────────┘
```

### 5.2 主要界面组件

#### 5.2.1 用户列表
- 显示所有在线用户
- 用户状态指示（在线/离线）
- 双击打开聊天窗口

#### 5.2.2 聊天窗口
- 消息历史显示
- 消息输入框
- 发送按钮、文件按钮
- 支持表情选择（可选）

#### 5.2.3 系统托盘
- 最小化到系统托盘
- 新消息提醒
- 快速打开主窗口

## 6. 项目目录结构

```
mini_chat2/
├── docs/                    # 文档目录
│   ├── 设计文档.md
│   ├── 开发计划.md
│   └── 技术规格说明.md
├── src/                     # 源代码目录
│   ├── __init__.py
│   ├── main.py             # 程序入口
│   ├── config.py           # 配置文件
│   ├── network/            # 网络模块
│   │   ├── __init__.py
│   │   ├── broadcast.py    # UDP广播服务
│   │   ├── message.py      # TCP消息服务
│   │   └── file_transfer.py # 文件传输
│   ├── core/               # 核心业务逻辑
│   │   ├── __init__.py
│   │   ├── user_manager.py # 用户管理
│   │   ├── message_manager.py # 消息管理
│   │   └── models.py       # 数据模型
│   ├── ui/                 # 界面模块
│   │   ├── __init__.py
│   │   ├── main_window.py  # 主窗口逻辑
│   │   ├── chat_window.py  # 聊天窗口逻辑
│   │   ├── settings_dialog.py # 设置对话框逻辑
│   │   ├── file_transfer_dialog.py # 文件传输对话框逻辑
│   │   ├── widgets/        # 自定义组件
│   │   │   ├── __init__.py
│   │   │   ├── user_list_widget.py    # 用户列表组件
│   │   │   ├── message_bubble.py      # 消息气泡组件
│   │   │   └── chat_input_widget.py   # 聊天输入组件
│   │   └── generated/      # pyuic 生成的 Python 文件
│   │       ├── __init__.py
│   │       ├── ui_main_window.py      # 由 main_window.ui 生成
│   │       ├── ui_chat_window.py      # 由 chat_window.ui 生成
│   │       ├── ui_settings_dialog.py  # 由 settings_dialog.ui 生成
│   │       └── ui_file_transfer_dialog.py # 由 file_transfer_dialog.ui 生成
│   ├── database/           # 数据库模块
│   │   ├── __init__.py
│   │   └── db_manager.py   # 数据库管理
│   └── utils/              # 工具类
│       ├── __init__.py
│       ├── logger.py       # 日志工具
│       └── crypto.py       # 加密工具（可选）
├── ui/                     # Qt Designer UI 文件目录
│   ├── main_window.ui      # 主窗口界面
│   ├── chat_window.ui      # 聊天窗口界面
│   ├── settings_dialog.ui  # 设置对话框界面
│   ├── file_transfer_dialog.ui # 文件传输对话框界面
│   └── README.md           # UI 文件说明文档
├── resources/              # 资源文件
│   ├── icons/             # 图标
│   │   ├── app.png        # 应用图标
│   │   ├── user.png       # 用户图标
│   │   ├── send.png       # 发送按钮图标
│   │   └── file.png       # 文件图标
│   ├── images/            # 图片
│   ├── styles/            # 样式表
│   │   ├── light.qss      # 浅色主题
│   │   └── dark.qss       # 深色主题
│   └── resources.qrc      # Qt 资源文件
├── tests/                 # 测试代码
│   ├── __init__.py
│   ├── test_network.py
│   ├── test_user_manager.py
│   └── test_message.py
├── data/                  # 数据目录
│   └── chat.db           # SQLite数据库
├── logs/                  # 日志目录
│   └── minichat.log      # 应用日志
├── scripts/               # 工具脚本
│   ├── compile_ui.py     # 编译所有 .ui 文件为 .py
│   └── compile_qrc.py    # 编译 .qrc 资源文件
├── requirements.txt       # 依赖列表
├── README.md             # 项目说明
└── setup.py              # 安装脚本
```

### 6.1 UI 文件组织说明

#### 6.1.1 UI 文件目录结构
- **ui/** 目录：存放所有 Qt Designer 设计的 `.ui` 文件
- **src/ui/generated/** 目录：存放由 `.ui` 文件编译生成的 Python 代码
- **src/ui/** 目录：存放窗口逻辑代码，继承并扩展生成的 UI 类

#### 6.1.2 UI 文件命名规范
- UI 文件名：使用小写字母和下划线，如 `main_window.ui`
- 生成的 Python 文件：添加 `ui_` 前缀，如 `ui_main_window.py`
- 逻辑文件：与 UI 文件同名，如 `main_window.py`

#### 6.1.3 UI 编译流程
使用 `pyuic5` 工具将 `.ui` 文件转换为 Python 代码：

```bash
# 单个文件编译
pyuic5 ui/main_window.ui -o src/ui/generated/ui_main_window.py

# 批量编译（使用脚本）
python scripts/compile_ui.py
```

#### 6.1.4 UI 使用模式
采用**继承模式**，将设计和逻辑分离：

```python
# src/ui/main_window.py
from PyQt5.QtWidgets import QMainWindow
from src.ui.generated.ui_main_window import Ui_MainWindow

class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        # 初始化 UI
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        
        # 连接信号槽
        self._setup_connections()
        
    def _setup_connections(self):
        """设置信号槽连接"""
        self.ui.sendButton.clicked.connect(self.on_send_clicked)
        
    def on_send_clicked(self):
        """发送按钮点击处理"""
        pass
```

#### 6.1.5 资源文件管理
- **resources.qrc**: 定义所有图标、图片等资源
- 使用 `pyrcc5` 编译为 Python 模块
- 在代码中通过资源路径引用

```bash
# 编译资源文件
pyrcc5 resources/resources.qrc -o src/ui/generated/resources_rc.py
```

#### 6.1.6 自动化脚本
**scripts/compile_ui.py** - 批量编译 UI 文件：

```python
#!/usr/bin/env python3
"""批量编译 .ui 文件为 .py 文件"""
import os
import subprocess
from pathlib import Path

UI_DIR = Path('ui')
OUT_DIR = Path('src/ui/generated')

def compile_ui_files():
    """编译所有 .ui 文件"""
    for ui_file in UI_DIR.glob('*.ui'):
        out_file = OUT_DIR / f'ui_{ui_file.stem}.py'
        print(f'Compiling {ui_file} -> {out_file}')
        subprocess.run([
            'pyuic5',
            str(ui_file),
            '-o',
            str(out_file)
        ])

if __name__ == '__main__':
    compile_ui_files()
```

## 7. 开发计划

### 7.1 第一阶段：基础框架（1-2周）
- [x] 项目结构搭建
- [ ] 基础配置管理
- [ ] 日志系统
- [ ] 数据库设计与实现

### 7.2 第二阶段：网络通信（2-3周）
- [ ] UDP 广播服务实现
- [ ] TCP 消息服务实现
- [ ] 用户发现机制
- [ ] 消息收发测试

### 7.3 第三阶段：核心功能（2-3周）
- [ ] 用户管理功能
- [ ] 消息管理功能
- [ ] 聊天历史存储
- [ ] 消息队列处理

### 7.4 第四阶段：界面开发（2-3周）
- [ ] 主窗口设计与实现
- [ ] 聊天窗口实现
- [ ] 用户列表组件
- [ ] 消息显示组件

### 7.5 第五阶段：高级功能（2周）
- [ ] 文件传输功能
- [ ] 群组聊天
- [ ] 表情支持
- [ ] 系统托盘

### 7.6 第六阶段：测试与优化（1-2周）
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能优化
- [ ] Bug 修复

## 8. 技术要点

### 8.1 多线程设计
- UI 线程：处理界面更新
- 网络监听线程：监听 UDP 广播
- TCP 服务线程：处理 TCP 连接
- 消息处理线程：处理消息队列

### 8.2 线程安全
- 使用 QMutex 保护共享数据
- 使用信号槽机制跨线程通信
- 消息队列使用线程安全的数据结构

### 8.3 异常处理
- 网络异常处理
- 文件读写异常
- 数据库异常
- 完善的日志记录

### 8.4 性能优化
- 消息缓存机制
- 数据库连接池
- 大文件分块传输
- 图片压缩与缓存

## 9. 安全考虑

### 9.1 基础安全
- 输入验证
- 文件类型检查
- 文件大小限制
- 防止恶意广播

### 9.2 可选增强
- 消息加密（AES）
- 数字签名验证
- 白名单机制
- 访问控制

## 10. 后续扩展方向

### 10.1 功能扩展
- 语音通话
- 视频通话
- 屏幕共享
- 远程协助

### 10.2 跨平台
- Windows 可执行文件打包
- macOS 应用打包
- Linux 支持

### 10.3 云同步（可选）
- 消息云同步
- 配置云同步
- 多设备支持

## 11. 依赖库列表

```txt
PyQt5>=5.15.0
PyQt5-Qt5>=5.15.0
PyQt5-sip>=12.8.0
```

可选依赖：
```txt
zeroconf>=0.38.0      # 服务发现
cryptography>=3.4.0   # 加密功能
pillow>=8.0.0         # 图片处理
```

## 12. 配置文件示例

```python
# config.py
class Config:
    # 网络配置
    BROADCAST_PORT = 9999
    MESSAGE_PORT = 10000
    BROADCAST_INTERVAL = 5  # 秒
    
    # 用户配置
    DEFAULT_USERNAME = ""  # 留空使用主机名
    
    # 文件传输配置
    CHUNK_SIZE = 4096
    MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB
    
    # 数据库配置
    DB_PATH = "data/chat.db"
    
    # UI配置
    WINDOW_WIDTH = 900
    WINDOW_HEIGHT = 600
    
    # 日志配置
    LOG_LEVEL = "INFO"
    LOG_FILE = "logs/minichat.log"
```

---

**文档版本**: v1.0  
**创建日期**: 2026-01-21  
**最后更新**: 2026-01-21
