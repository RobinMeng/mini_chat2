# 开发指南

## 已完成功能

### ✅ 基础框架
- [x] 项目目录结构
- [x] 配置管理系统
- [x] 日志系统
- [x] 数据库管理

### ✅ 核心业务
- [x] 用户管理器（UserManager）
- [x] 消息管理器（MessageManager）
- [x] 数据模型（User、Message、FileTransfer）

### ✅ 网络功能
- [x] UDP 广播服务（用户发现）
- [x] TCP 消息服务（点对点通信）
- [x] 消息协议（带长度前缀）

### ✅ UI 界面
- [x] 主窗口（MainWindow）
- [x] 用户列表显示
- [x] 聊天消息显示
- [x] 消息输入和发送
- [x] 美化的界面样式

## 运行应用

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行主程序

```bash
python src/main.py
```

### 3. 测试网络功能

测试广播服务：
```bash
python tests/test_network_simple.py broadcast
```

测试消息服务：
```bash
python tests/test_network_simple.py message
```

## 使用说明

### 启动应用
1. 运行 `python src/main.py` 启动应用
2. 应用会自动：
   - 初始化数据库
   - 创建当前用户
   - 启动 UDP 广播服务
   - 启动 TCP 消息服务
   - 显示主窗口

### 发现用户
- 在同一局域网内运行多个实例
- 用户会自动出现在左侧用户列表中
- 用户列表显示所有在线用户

### 发送消息
1. 双击左侧用户列表中的用户
2. 在下方输入框输入消息
3. 点击"发送"按钮或按 Enter 键发送
4. 消息会显示在聊天区域

### 接收消息
- 接收到的消息会自动显示在聊天区域
- 自己的消息显示在右侧（蓝色）
- 对方的消息显示在左侧（灰色）

## 技术细节

### 网络协议

#### UDP 广播协议
```json
{
    "type": "HEARTBEAT",
    "version": "1.0",
    "user_id": "unique_user_id",
    "username": "用户昵称",
    "hostname": "主机名",
    "ip": "192.168.1.100",
    "tcp_port": 10000,
    "timestamp": 1234567890
}
```

- 端口：9999
- 间隔：每 5 秒发送一次
- 功能：局域网内用户发现

#### TCP 消息协议
```
[4字节长度][消息JSON数据]
```

消息格式：
```json
{
    "msg_id": "msg_1234567890_abc123",
    "type": "TEXT",
    "from_user_id": "user_id_1",
    "from_username": "Alice",
    "to_user_id": "user_id_2",
    "to_username": "Bob",
    "content": "Hello!",
    "timestamp": 1234567890
}
```

- 端口：10000
- 功能：点对点消息传输

### 数据库结构

#### users 表
```sql
CREATE TABLE users (
    user_id TEXT PRIMARY KEY,
    username TEXT NOT NULL,
    hostname TEXT,
    ip_address TEXT,
    tcp_port INTEGER,
    status TEXT DEFAULT 'offline',
    last_seen INTEGER,
    avatar TEXT,
    created_at INTEGER,
    updated_at INTEGER
);
```

#### messages 表
```sql
CREATE TABLE messages (
    msg_id TEXT PRIMARY KEY,
    type TEXT NOT NULL,
    from_user_id TEXT NOT NULL,
    from_username TEXT,
    to_user_id TEXT NOT NULL,
    to_username TEXT,
    content TEXT,
    timestamp INTEGER,
    is_group INTEGER DEFAULT 0,
    group_id TEXT,
    is_read INTEGER DEFAULT 0,
    status TEXT DEFAULT 'sent',
    created_at INTEGER
);
```

## 待开发功能

### 文件传输
- [ ] 文件选择对话框
- [ ] 文件元数据传输
- [ ] 文件分块传输
- [ ] 传输进度显示
- [ ] MD5 校验

### 群组聊天
- [ ] 创建群组
- [ ] 群组成员管理
- [ ] 群组消息广播

### UI 增强
- [ ] 系统托盘
- [ ] 新消息通知
- [ ] 表情选择器
- [ ] 消息撤回
- [ ] 聊天记录搜索

### 其他功能
- [ ] 用户设置对话框
- [ ] 主题切换（浅色/深色）
- [ ] 消息加密
- [ ] 离线消息

## 调试技巧

### 查看日志
日志文件位置：`logs/minichat.log`

```bash
# 实时查看日志
tail -f logs/minichat.log
```

### 测试多用户
在不同的终端窗口运行多个实例：

```bash
# 终端 1
python src/main.py

# 终端 2（修改端口避免冲突）
# 需要修改 config.py 中的端口配置
python src/main.py
```

### 网络抓包
使用 Wireshark 或 tcpdump 查看网络流量：

```bash
# 查看 UDP 广播
sudo tcpdump -i any -n udp port 9999

# 查看 TCP 消息
sudo tcpdump -i any -n tcp port 10000
```

## 常见问题

### Q: 无法发现其他用户？
A: 检查以下几点：
1. 是否在同一局域网内
2. 防火墙是否允许 UDP 9999 端口
3. 查看日志确认广播服务是否正常运行

### Q: 消息发送失败？
A: 检查以下几点：
1. 防火墙是否允许 TCP 10000 端口
2. 目标用户是否在线
3. 查看日志确认错误信息

### Q: 端口被占用？
A: 修改 `src/config.py` 中的端口配置：
```python
BROADCAST_PORT = 9999  # 改为其他端口
TCP_PORT = 10000       # 改为其他端口
```

## 项目结构说明

```
src/
├── main.py              # 程序入口
├── config.py            # 配置管理
├── core/                # 核心业务
│   ├── models.py        # 数据模型
│   ├── user_manager.py  # 用户管理
│   └── message_manager.py # 消息管理
├── network/             # 网络通信
│   ├── broadcast.py     # UDP 广播
│   ├── message.py       # TCP 消息
│   └── file_transfer.py # 文件传输
├── ui/                  # 界面模块
│   └── main_window.py   # 主窗口
├── database/            # 数据库
│   └── db_manager.py    # 数据库管理
└── utils/               # 工具类
    └── logger.py        # 日志工具
```

## 下一步开发建议

1. **完善文件传输功能**
   - 实现文件选择和发送
   - 添加传输进度条
   - 实现断点续传

2. **增强用户体验**
   - 添加系统托盘
   - 实现新消息通知
   - 添加表情支持

3. **提高可靠性**
   - 添加消息重发机制
   - 实现离线消息存储
   - 添加消息加密

4. **性能优化**
   - 优化消息显示性能
   - 添加消息分页加载
   - 优化网络连接管理
