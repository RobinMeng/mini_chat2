# MiniChat 技术规格说明

## 1. 网络协议规范

### 1.1 UDP 广播协议

#### 端口配置
- **广播端口**: 9999
- **广播地址**: 255.255.255.255
- **广播间隔**: 5 秒

#### 消息类型

##### 1.1.1 HEARTBEAT（心跳包）
用户定期广播自己的在线状态。

**请求格式**:
```json
{
    "type": "HEARTBEAT",
    "version": "1.0",
    "user_id": "a1b2c3d4e5f6",
    "username": "Alice",
    "hostname": "Alice-MacBook",
    "ip": "192.168.1.100",
    "tcp_port": 10000,
    "timestamp": 1737446400,
    "avatar": ""
}
```

**字段说明**:
- `type`: 消息类型，固定为 "HEARTBEAT"
- `version`: 协议版本号
- `user_id`: 用户唯一标识（MAC地址哈希）
- `username`: 用户昵称
- `hostname`: 主机名
- `ip`: 本机 IP 地址
- `tcp_port`: TCP 监听端口
- `timestamp`: Unix 时间戳
- `avatar`: 用户头像（Base64 编码，可选）

##### 1.1.2 USER_LEAVE（用户离开）
用户主动退出时广播。

**请求格式**:
```json
{
    "type": "USER_LEAVE",
    "version": "1.0",
    "user_id": "a1b2c3d4e5f6",
    "timestamp": 1737446400
}
```

#### 超时机制
- 15 秒内未收到心跳包，标记用户为离线
- 30 秒后从用户列表中移除

---

### 1.2 TCP 消息协议

#### 端口配置
- **默认端口**: 10000
- **连接类型**: 点对点 TCP 连接
- **并发模型**: **I/O 多路复用 (selectors)**，单线程处理所有客户端连接
- **编码格式**: UTF-8

#### 消息结构
为了解决 TCP 粘包和半包问题，所有 TCP 消息采用 **长度前缀协议**：

```
┌────────────┬─────────────────────────┐
│  4 字节     │     N 字节               │
│  消息长度   │     JSON 消息体          │
└────────────┴─────────────────────────┘
```

**字段说明**:
- **消息长度**: 4 字节大端字节序 (Big Endian) 整数，表示后续 JSON 消息体的字节长度。
- **JSON 消息体**: UTF-8 编码的 JSON 字符串，包含具体的业务数据。

#### 协议实现 (network_utils.py)
所有 TCP 通讯逻辑统一收拢在工具类中，确保协议解析的一致性：
- `send_json(sock, data)`: 自动序列化并添加长度前缀发送。
- `read_and_unpack(sock, buffer)`: 针对非阻塞模式设计的流式解析函数，能从字节流中连续提取完整的 JSON 消息。

---

### 1.3 文本消息

#### 1.3.1 TEXT（文本消息）

**发送格式**:
```json
{
    "msg_id": "msg_1737446400_001",
    "type": "TEXT",
    "from_user_id": "a1b2c3d4e5f6",
    "from_username": "Alice",
    "to_user_id": "b2c3d4e5f6a1",
    "to_username": "Bob",
    "content": "Hello, Bob!",
    "timestamp": 1737446400,
    "is_group": false,
    "group_id": null
}
```

**字段说明**:
- `msg_id`: 消息唯一标识
- `type`: 消息类型
- `from_user_id`: 发送者 ID
- `from_username`: 发送者昵称
- `to_user_id`: 接收者 ID（一对一）
- `to_username`: 接收者昵称
- `content`: 消息内容
- `timestamp`: 发送时间戳
- `is_group`: 是否群组消息
- `group_id`: 群组 ID（群聊时使用）

#### 1.3.2 ACK（消息确认）

**响应格式**:
```json
{
    "type": "ACK",
    "msg_id": "msg_1737446400_001",
    "status": "received",
    "timestamp": 1737446401
}
```

**状态值**:
- `received`: 已接收
- `read`: 已读
- `failed`: 发送失败

---

### 1.4 文件传输协议

#### 1.4.1 FILE_META（文件元数据）

**发送格式**:
```json
{
    "type": "FILE_META",
    "file_id": "file_1737446400_001",
    "from_user_id": "a1b2c3d4e5f6",
    "to_user_id": "b2c3d4e5f6a1",
    "filename": "document.pdf",
    "filesize": 1024000,
    "file_type": "application/pdf",
    "checksum": "5d41402abc4b2a76b9719d911017c592",
    "chunk_size": 4096,
    "total_chunks": 250,
    "timestamp": 1737446400
}
```

**字段说明**:
- `file_id`: 文件传输唯一标识
- `filename`: 文件名
- `filesize`: 文件大小（字节）
- `file_type`: MIME 类型
- `checksum`: MD5 校验和
- `chunk_size`: 每块大小
- `total_chunks`: 总块数

#### 1.4.2 FILE_ACK（文件接收确认）

**响应格式**:
```json
{
    "type": "FILE_ACK",
    "file_id": "file_1737446400_001",
    "action": "accept",
    "save_path": "/path/to/save",
    "timestamp": 1737446401
}
```

**操作类型**:
- `accept`: 接受文件
- `reject`: 拒绝文件

#### 1.4.3 FILE_DATA（文件数据块）

**发送格式**:
```json
{
    "type": "FILE_DATA",
    "file_id": "file_1737446400_001",
    "chunk_index": 0,
    "chunk_data": "base64_encoded_data",
    "chunk_checksum": "checksum_of_chunk"
}
```

#### 1.4.4 FILE_COMPLETE（传输完成）

**发送格式**:
```json
{
    "type": "FILE_COMPLETE",
    "file_id": "file_1737446400_001",
    "status": "success",
    "checksum": "5d41402abc4b2a76b9719d911017c592"
}
```

---

## 2. 数据模型规范

### 2.1 User（用户）

```python
class User:
    def __init__(self):
        self.user_id: str = ""          # 用户唯一标识
        self.username: str = ""          # 用户昵称
        self.hostname: str = ""          # 主机名
        self.ip_address: str = ""        # IP 地址
        self.tcp_port: int = 10000       # TCP 端口
        self.status: str = "online"      # 状态：online/offline
        self.last_seen: int = 0          # 最后在线时间
        self.avatar: str = ""            # 头像（Base64）
```

### 2.2 Message（消息）

```python
class Message:
    def __init__(self):
        self.msg_id: str = ""            # 消息 ID
        self.type: str = "TEXT"          # 消息类型
        self.from_user_id: str = ""      # 发送者 ID
        self.from_username: str = ""     # 发送者昵称
        self.to_user_id: str = ""        # 接收者 ID
        self.to_username: str = ""       # 接收者昵称
        self.content: str = ""           # 消息内容
        self.timestamp: int = 0          # 时间戳
        self.is_group: bool = False      # 是否群消息
        self.group_id: str = None        # 群组 ID
        self.is_read: bool = False       # 是否已读
        self.status: str = "sending"     # 状态：sending/sent/received/read/failed
```

### 2.3 FileTransfer（文件传输）

```python
class FileTransfer:
    def __init__(self):
        self.file_id: str = ""           # 文件传输 ID
        self.from_user_id: str = ""      # 发送者 ID
        self.to_user_id: str = ""        # 接收者 ID
        self.filename: str = ""          # 文件名
        self.filesize: int = 0           # 文件大小
        self.file_type: str = ""         # 文件类型
        self.checksum: str = ""          # MD5 校验和
        self.save_path: str = ""         # 保存路径
        self.chunk_size: int = 4096      # 块大小
        self.total_chunks: int = 0       # 总块数
        self.transferred_chunks: int = 0 # 已传输块数
        self.status: str = "pending"     # 状态：pending/transferring/completed/failed
        self.progress: float = 0.0       # 进度（0-100）
        self.start_time: int = 0         # 开始时间
        self.end_time: int = 0           # 结束时间
```

---

## 3. 数据库设计

### 3.1 表结构

#### users 表
```sql
CREATE TABLE IF NOT EXISTS users (
    user_id TEXT PRIMARY KEY,
    username TEXT NOT NULL,
    hostname TEXT,
    ip_address TEXT,
    tcp_port INTEGER,
    status TEXT DEFAULT 'offline',
    last_seen INTEGER,
    avatar TEXT,
    created_at INTEGER,
    updated_at INTEGER
);

CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_last_seen ON users(last_seen);
```

#### messages 表
```sql
CREATE TABLE IF NOT EXISTS messages (
    msg_id TEXT PRIMARY KEY,
    type TEXT NOT NULL,
    from_user_id TEXT NOT NULL,
    from_username TEXT,
    to_user_id TEXT NOT NULL,
    to_username TEXT,
    content TEXT,
    timestamp INTEGER,
    is_group INTEGER DEFAULT 0,
    group_id TEXT,
    is_read INTEGER DEFAULT 0,
    status TEXT DEFAULT 'sent',
    created_at INTEGER,
    FOREIGN KEY (from_user_id) REFERENCES users(user_id),
    FOREIGN KEY (to_user_id) REFERENCES users(user_id)
);

CREATE INDEX idx_messages_from_user ON messages(from_user_id);
CREATE INDEX idx_messages_to_user ON messages(to_user_id);
CREATE INDEX idx_messages_timestamp ON messages(timestamp);
CREATE INDEX idx_messages_is_read ON messages(is_read);
```

#### file_transfers 表
```sql
CREATE TABLE IF NOT EXISTS file_transfers (
    file_id TEXT PRIMARY KEY,
    from_user_id TEXT NOT NULL,
    to_user_id TEXT NOT NULL,
    filename TEXT NOT NULL,
    filesize INTEGER,
    file_type TEXT,
    checksum TEXT,
    save_path TEXT,
    chunk_size INTEGER,
    total_chunks INTEGER,
    transferred_chunks INTEGER DEFAULT 0,
    status TEXT DEFAULT 'pending',
    progress REAL DEFAULT 0.0,
    start_time INTEGER,
    end_time INTEGER,
    created_at INTEGER,
    FOREIGN KEY (from_user_id) REFERENCES users(user_id),
    FOREIGN KEY (to_user_id) REFERENCES users(user_id)
);

CREATE INDEX idx_file_transfers_status ON file_transfers(status);
CREATE INDEX idx_file_transfers_from_user ON file_transfers(from_user_id);
CREATE INDEX idx_file_transfers_to_user ON file_transfers(to_user_id);
```

#### settings 表
```sql
CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT,
    updated_at INTEGER
);
```

---

## 4. API 接口规范

### 4.1 UserManager API

#### get_user_id()
生成或获取当前用户的唯一 ID。

**返回值**: `str`

#### get_online_users()
获取所有在线用户列表。

**返回值**: `List[User]`

#### add_user(user: User)
添加或更新用户信息。

**参数**:
- `user`: User 对象

**返回值**: `bool`

#### remove_user(user_id: str)
移除用户。

**参数**:
- `user_id`: 用户 ID

**返回值**: `bool`

#### get_user(user_id: str)
根据 ID 获取用户信息。

**参数**:
- `user_id`: 用户 ID

**返回值**: `User | None`

---

### 4.2 MessageManager API

#### send_message(message: Message)
发送消息。

**参数**:
- `message`: Message 对象

**返回值**: `bool`

#### receive_message(message: Message)
接收消息。

**参数**:
- `message`: Message 对象

**返回值**: `bool`

#### get_chat_history(user_id: str, limit: int = 50)
获取与指定用户的聊天历史。

**参数**:
- `user_id`: 用户 ID
- `limit`: 消息数量限制

**返回值**: `List[Message]`

#### mark_as_read(msg_id: str)
标记消息为已读。

**参数**:
- `msg_id`: 消息 ID

**返回值**: `bool`

#### get_unread_count(user_id: str)
获取未读消息数量。

**参数**:
- `user_id`: 用户 ID

**返回值**: `int`

---

### 4.3 FileTransferService API

#### send_file(from_user_id: str, to_user_id: str, file_path: str)
发送文件。

**参数**:
- `from_user_id`: 发送者 ID
- `to_user_id`: 接收者 ID
- `file_path`: 文件路径

**返回值**: `str` (file_id)

#### accept_file(file_id: str, save_path: str)
接受文件。

**参数**:
- `file_id`: 文件传输 ID
- `save_path`: 保存路径

**返回值**: `bool`

#### reject_file(file_id: str)
拒绝文件。

**参数**:
- `file_id`: 文件传输 ID

**返回值**: `bool`

#### get_transfer_progress(file_id: str)
获取传输进度。

**参数**:
- `file_id`: 文件传输 ID

**返回值**: `float` (0-100)

---

## 5. 配置规范

### 5.1 config.py

```python
import os
from pathlib import Path

class Config:
    """应用程序配置"""
    
    # 应用信息
    APP_NAME = "MiniChat"
    APP_VERSION = "1.0.0"
    
    # 路径配置
    BASE_DIR = Path(__file__).parent.parent
    DATA_DIR = BASE_DIR / "data"
    LOG_DIR = BASE_DIR / "logs"
    RESOURCE_DIR = BASE_DIR / "resources"
    
    # 网络配置
    BROADCAST_PORT = 9999
    TCP_PORT = 10000
    BROADCAST_INTERVAL = 5  # 秒
    HEARTBEAT_TIMEOUT = 15  # 秒
    USER_REMOVE_TIMEOUT = 30  # 秒
    BROADCAST_ADDRESS = "255.255.255.255"
    
    # 用户配置
    DEFAULT_USERNAME = ""  # 留空使用主机名
    MAX_USERNAME_LENGTH = 20
    
    # 消息配置
    MAX_MESSAGE_LENGTH = 5000
    MESSAGE_HISTORY_LIMIT = 100
    
    # 文件传输配置
    CHUNK_SIZE = 4096  # 4KB
    MAX_FILE_SIZE = 100 * 1024 * 1024  # 100MB
    ALLOWED_FILE_TYPES = [
        'txt', 'pdf', 'doc', 'docx', 'xls', 'xlsx',
        'jpg', 'jpeg', 'png', 'gif', 'bmp',
        'zip', 'rar', '7z', 'tar', 'gz'
    ]
    
    # 数据库配置
    DB_NAME = "chat.db"
    DB_PATH = DATA_DIR / DB_NAME
    
    # 日志配置
    LOG_LEVEL = "INFO"
    LOG_FILE = LOG_DIR / "minichat.log"
    LOG_MAX_SIZE = 10 * 1024 * 1024  # 10MB
    LOG_BACKUP_COUNT = 5
    LOG_FORMAT = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    
    # UI 配置
    WINDOW_WIDTH = 900
    WINDOW_HEIGHT = 600
    WINDOW_MIN_WIDTH = 700
    WINDOW_MIN_HEIGHT = 500
    
    # 主题配置
    THEME = "light"  # light/dark
    
    @classmethod
    def init_dirs(cls):
        """初始化必要的目录"""
        cls.DATA_DIR.mkdir(exist_ok=True)
        cls.LOG_DIR.mkdir(exist_ok=True)
```

---

## 6. 错误码规范

```python
class ErrorCode:
    """错误码定义"""
    SUCCESS = 0
    
    # 网络错误 (1000-1999)
    NETWORK_ERROR = 1000
    CONNECTION_FAILED = 1001
    CONNECTION_TIMEOUT = 1002
    SEND_FAILED = 1003
    RECEIVE_FAILED = 1004
    
    # 用户错误 (2000-2999)
    USER_NOT_FOUND = 2000
    USER_OFFLINE = 2001
    USER_BLOCKED = 2002
    INVALID_USER_ID = 2003
    
    # 消息错误 (3000-3999)
    MESSAGE_TOO_LONG = 3000
    INVALID_MESSAGE_FORMAT = 3001
    MESSAGE_SEND_FAILED = 3002
    
    # 文件错误 (4000-4999)
    FILE_NOT_FOUND = 4000
    FILE_TOO_LARGE = 4001
    FILE_TYPE_NOT_ALLOWED = 4002
    FILE_TRANSFER_FAILED = 4003
    FILE_CHECKSUM_ERROR = 4004
    
    # 数据库错误 (5000-5999)
    DATABASE_ERROR = 5000
    QUERY_FAILED = 5001
    INSERT_FAILED = 5002
    UPDATE_FAILED = 5003
    DELETE_FAILED = 5004
    
    # 其他错误 (9000-9999)
    UNKNOWN_ERROR = 9000
    INVALID_PARAMETER = 9001
    PERMISSION_DENIED = 9002
```

---

**文档版本**: v1.1  
**创建日期**: 2026-01-21  
**最后更新**: 2026-01-23 (重构网络架构为 I/O 多路复用)
